From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: GideonWhite1029 <gideonwhite1029@gmail.com>
Date: Sat, 13 Apr 2024 21:11:06 +0400
Subject: [PATCH] Fakeplayer Support


diff --git a/src/main/java/dev/horizonmc/horizon/entity/Bot.java b/src/main/java/dev/horizonmc/horizon/entity/Bot.java
new file mode 100644
index 0000000000000000000000000000000000000000..539c04e9fa11f68d907c7644d7202339a9eaeaab
--- /dev/null
+++ b/src/main/java/dev/horizonmc/horizon/entity/Bot.java
@@ -0,0 +1,51 @@
+package dev.horizonmc.horizon.entity;
+
+import dev.horizonmc.horizon.entity.botaction.HorizonBotAction;
+import org.bukkit.entity.Player;
+import org.jetbrains.annotations.NotNull;
+import org.jetbrains.annotations.Nullable;
+
+import java.util.UUID;
+
+/**
+ * Represents a fakeplayer
+ */
+public interface Bot extends Player {
+
+    /**
+     * Gets the fakeplayer skin
+     *
+     * @return fakeplayer skin name
+     */
+    @Nullable
+    public String getSkinName();
+
+    /**
+     * Gets the fakeplayer name without prefix and suffix
+     *
+     * @return fakeplayer real name
+     */
+    @NotNull
+    public String getRealName();
+
+    @Nullable
+    public UUID getCreatePlayerUUID();
+
+    /**
+     * Sets the fakeplayer action with args.
+     *
+     * @param action action name
+     * @param player player who create this action
+     * @param args   passed action arguments
+     */
+    public boolean setBotAction(@NotNull String action, @NotNull Player player, @NotNull String[] args);
+
+    /**
+     * Sets the fakeplayer action with args.
+     *
+     * @param action leaves bot action
+     * @param player player who create this action
+     * @param args   passed action arguments
+     */
+    public boolean setBotAction(@NotNull HorizonBotAction action, @NotNull Player player, @NotNull String[] args);
+}
diff --git a/src/main/java/dev/horizonmc/horizon/entity/BotManager.java b/src/main/java/dev/horizonmc/horizon/entity/BotManager.java
new file mode 100644
index 0000000000000000000000000000000000000000..e1eceeb6d53062885993bcbc0849c46afe878d0f
--- /dev/null
+++ b/src/main/java/dev/horizonmc/horizon/entity/BotManager.java
@@ -0,0 +1,107 @@
+package dev.horizonmc.horizon.entity;
+
+import dev.horizonmc.horizon.entity.botaction.CustomBotAction;
+import org.bukkit.Location;
+import org.bukkit.util.Consumer;
+import org.jetbrains.annotations.NotNull;
+import org.jetbrains.annotations.Nullable;
+
+import java.util.Collection;
+import java.util.UUID;
+
+/**
+ * Simple fakeplayer manager
+ */
+public interface BotManager {
+
+    /**
+     * Gets a fakeplayer object by the given uuid.
+     *
+     * @param uuid the uuid to look up
+     * @return a fakeplayer if one was found, null otherwise
+     */
+    @Nullable
+    public Bot getBot(@NotNull UUID uuid);
+
+    /**
+     * Gets a fakeplayer object by the given name.
+     *
+     * @param name the name to look up
+     * @return a fakeplayer if one was found, null otherwise
+     */
+    @Nullable
+    public Bot getBot(@NotNull String name);
+
+    /**
+     * Creates a fakeplayer with given param.
+     * <p>
+     * prefix and suffix will not be added.
+     *
+     * @param name     fakeplayer name
+     * @param realName fakeplayer real name
+     * @param skin     fakeplayer skin arr
+     * @param skinName fakeplayer skin name
+     * @param location a location will create fakeplayer
+     * @return a fakeplayer if success, null otherwise
+     */
+    @Nullable
+    public Bot createBot(@NotNull String name, @NotNull String realName, @Nullable String[] skin, @Nullable String skinName, @NotNull Location location);
+
+    /**
+     * Creates a fakeplayer with given param.
+     *
+     * @param name     fakeplayer name
+     * @param skinName fakeplayer skin name
+     * @param location a location will create fakeplayer
+     * @param consumer a consumer after create fakeplayer success
+     */
+    public void createBot(@NotNull String name, @Nullable String skinName, @NotNull Location location, @Nullable Consumer<Bot> consumer);
+
+    /**
+     * Removes a fakeplayer object by the given name.
+     *
+     * @param name the name to look up
+     */
+    public void removeBot(@NotNull String name);
+
+    /**
+     * Removes a fakeplayer object by the given uuid.
+     *
+     * @param uuid the uuid to look up
+     */
+    public void removeBot(@NotNull UUID uuid);
+
+    /**
+     * Removes all fakeplayers.
+     */
+    public void removeAllBots();
+
+    /**
+     * Save fakeplayers data if resident-fakeplayer is true, or remove all fakeplayer.
+     */
+    public void saveOrRemoveAllBots();
+
+    /**
+     * Gets a view of all currently logged in fakeplayers. This view is a reused object, making some operations like Collection.size() zero-allocation.
+     *
+     * @return a view of fakeplayers.
+     */
+    public Collection<Bot> getBots();
+
+    /**
+     * Register a custom bot action.
+     *
+     * @param name   action name
+     * @param action action executor
+     * @return true if success, or false
+     */
+    public boolean registerCustomBotAction(String name, CustomBotAction action);
+
+    /**
+     * Unregister a custom bot action.
+     *
+     * @param name action name
+     * @return true if success, or false
+     */
+    public boolean unregisterCustomBotAction(String name);
+}
diff --git a/src/main/java/dev/horizonmc/horizon/entity/botaction/CustomBotAction.java b/src/main/java/dev/horizonmc/horizon/entity/botaction/CustomBotAction.java
new file mode 100644
index 0000000000000000000000000000000000000000..aadc6f81af946e58a94da59415f19c340ae60bcf
--- /dev/null
+++ b/src/main/java/dev/horizonmc/horizon/entity/botaction/CustomBotAction.java
@@ -0,0 +1,52 @@
+package dev.horizonmc.horizon.entity.botaction;
+
+import dev.horizonmc.horizon.entity.Bot;
+import org.bukkit.entity.Player;
+import org.jetbrains.annotations.NotNull;
+import org.jetbrains.annotations.Nullable;
+
+import java.util.List;
+
+/**
+ * Represents a class which contains methods for a custom bot action
+ */
+public interface CustomBotAction {
+
+    /**
+     * Executes the action, returning its success.
+     *
+     * @param bot bot of the action
+     * @return true if once action finish, otherwise false
+     */
+    public boolean doTick(Bot bot);
+
+    /**
+     * Created a new action instance.
+     *
+     * @param player player who create this action
+     * @param args   passed action arguments
+     * @return a new action instance with given args
+     */
+    public @Nullable CustomBotAction getNew(Player player, String[] args);
+
+    /**
+     * Requests a list of possible completions for a action argument.
+     *
+     * @return A List of a List of possible completions for the argument.
+     */
+    public @NotNull List<List<String>> getTabComplete();
+
+    /**
+     * Return a ticks to wait between {@link CustomBotAction#doTick(Bot)}
+     *
+     * @return the ticks to wait between runs
+     */
+    public int getTickDelay();
+
+    /**
+     * Return a number of times {@link CustomBotAction#doTick(Bot)} can return true
+     *
+     * @return the number of times an action can be executed
+     */
+    public int getNumber();
+}
diff --git a/src/main/java/dev/horizonmc/horizon/entity/botaction/HorizonBotAction.java b/src/main/java/dev/horizonmc/horizon/entity/botaction/HorizonBotAction.java
new file mode 100644
index 0000000000000000000000000000000000000000..c9affd016706e645b8933291d2cf7690f8006fb3
--- /dev/null
+++ b/src/main/java/dev/horizonmc/horizon/entity/botaction/HorizonBotAction.java
@@ -0,0 +1,32 @@
+package dev.horizonmc.horizon.entity.botaction;
+
+/**
+ * A Horizon bot action enum
+ */
+public enum HorizonBotAction {
+    ATTACK("attack"),
+    ATTACK_SELF("attack_self"),
+    BREAK("break"),
+    DROP("drop"),
+    FISH("fish"),
+    JUMP("jump"),
+    LAY("lay"),
+    LOOK("look"),
+    ROTATE("rotate"),
+    SNEAK("sneak"),
+    STOP("stop"),
+    SWIM("swim"),
+    USE("use"),
+    USE_ON("use_on"),
+    USE_TO("use_to");
+
+    private final String name;
+
+    private HorizonBotAction(String name) {
+        this.name = name;
+    }
+
+    public String getName() {
+        return name;
+    }
+}
diff --git a/src/main/java/dev/horizonmc/horizon/entity/event/bot/BotActionEvent.java b/src/main/java/dev/horizonmc/horizon/entity/event/bot/BotActionEvent.java
new file mode 100644
index 0000000000000000000000000000000000000000..1c43f7c75bcdb3a644a5730d1e9f5bde68be3e11
--- /dev/null
+++ b/src/main/java/dev/horizonmc/horizon/entity/event/bot/BotActionEvent.java
@@ -0,0 +1,49 @@
+package dev.horizonmc.horizon.entity.event.bot;
+
+import dev.horizonmc.horizon.entity.Bot;
+import org.bukkit.event.Cancellable;
+import org.bukkit.event.HandlerList;
+import org.jetbrains.annotations.NotNull;
+
+public class BotActionEvent extends BotEvent implements Cancellable {
+    private static final HandlerList handlers = new HandlerList();
+
+    private final String actionName;
+    private final String[] actionArgs;
+    private boolean cancel = false;
+
+    public BotActionEvent(@NotNull Bot who, String actionName, String[] actionArgs) {
+        super(who);
+        this.actionArgs = actionArgs;
+        this.actionName = actionName;
+    }
+
+    @NotNull
+    public String[] getActionArgs() {
+        return actionArgs;
+    }
+
+    @NotNull
+    public String getActionName() {
+        return actionName;
+    }
+
+    @Override
+    public @NotNull HandlerList getHandlers() {
+        return handlers;
+    }
+
+    @Override
+    public boolean isCancelled() {
+        return cancel;
+    }
+
+    @Override
+    public void setCancelled(boolean cancel) {
+        this.cancel = cancel;
+    }
+
+    public static HandlerList getHandlerList() {
+        return handlers;
+    }
+}
diff --git a/src/main/java/dev/horizonmc/horizon/entity/event/bot/BotConfigModifyEvent.java b/src/main/java/dev/horizonmc/horizon/entity/event/bot/BotConfigModifyEvent.java
new file mode 100644
index 0000000000000000000000000000000000000000..337de20adba511c71e067d974f57855a5b414f0b
--- /dev/null
+++ b/src/main/java/dev/horizonmc/horizon/entity/event/bot/BotConfigModifyEvent.java
@@ -0,0 +1,49 @@
+package dev.horizonmc.horizon.entity.event.bot;
+
+import dev.horizonmc.horizon.entity.Bot;
+import org.bukkit.event.Cancellable;
+import org.bukkit.event.HandlerList;
+import org.jetbrains.annotations.NotNull;
+
+public class BotConfigModifyEvent extends BotEvent implements Cancellable {
+    private static final HandlerList handlers = new HandlerList();
+
+    private final String configName;
+    private final String configValue;
+    private boolean cancel;
+
+    public BotConfigModifyEvent(@NotNull Bot who, String configName, String configValue) {
+        super(who);
+        this.configName = configName;
+        this.configValue = configValue;
+    }
+
+    @NotNull
+    public String getConfigName() {
+        return configName;
+    }
+
+    @NotNull
+    public String getConfigValue() {
+        return configValue;
+    }
+
+    @Override
+    public @NotNull HandlerList getHandlers() {
+        return handlers;
+    }
+
+    @Override
+    public boolean isCancelled() {
+        return cancel;
+    }
+
+    @Override
+    public void setCancelled(boolean cancel) {
+        this.cancel = cancel;
+    }
+
+    public static HandlerList getHandlerList() {
+        return handlers;
+    }
+}
diff --git a/src/main/java/dev/horizonmc/horizon/entity/event/bot/BotCreateEvent.java b/src/main/java/dev/horizonmc/horizon/entity/event/bot/BotCreateEvent.java
new file mode 100644
index 0000000000000000000000000000000000000000..0452ba137f83151f638373f92f6f80df84fd1c8d
--- /dev/null
+++ b/src/main/java/dev/horizonmc/horizon/entity/event/bot/BotCreateEvent.java
@@ -0,0 +1,106 @@
+package dev.horizonmc.horizon.entity.event.bot;
+
+import org.bukkit.Location;
+import org.bukkit.event.Cancellable;
+import org.bukkit.event.Event;
+import org.bukkit.event.HandlerList;
+import org.jetbrains.annotations.NotNull;
+import org.jetbrains.annotations.Nullable;
+
+/**
+ * Call when a fakeplayer creates a server
+ */
+public class BotCreateEvent extends Event implements Cancellable {
+    private static final HandlerList handlers = new HandlerList();
+
+    private final String bot;
+    private final String skin;
+    private String joinMessage;
+    private Location createLocation;
+    private boolean cancel = false;
+
+    public BotCreateEvent(@NotNull final String who, @NotNull final String skin, @NotNull final Location createLocation, @Nullable final String joinMessage) {
+        this.bot = who;
+        this.skin = skin;
+        this.joinMessage = joinMessage;
+        this.createLocation = createLocation;
+    }
+
+    /**
+     * Gets the fakeplayer name
+     *
+     * @return fakeplayer name
+     */
+    public String getBot() {
+        return bot;
+    }
+
+    /**
+     * Gets the join message to send to all online players
+     *
+     * @return string join message. Can be null
+     */
+    @Nullable
+    public String getJoinMessage() {
+        return joinMessage;
+    }
+
+    /**
+     * Sets the join message to send to all online players
+     *
+     * @param joinMessage join message. If null, no message will be sent
+     */
+    public void setJoinMessage(@Nullable String joinMessage) {
+        this.joinMessage = joinMessage;
+    }
+
+    /**
+     * Gets the location to create the fakeplayer
+     *
+     * @return Location to create the fakeplayer
+     */
+    @NotNull
+    public Location getCreateLocation() {
+        return createLocation;
+    }
+
+    /**
+     * Sets the location to create the fakeplayer
+     *
+     * @param createLocation location to create the fakeplayer
+     */
+    public void setCreateLocation(@NotNull Location createLocation) {
+        this.createLocation = createLocation;
+    }
+
+    /**
+     * Gets the fakeplayer skin
+     *
+     * @return fakeplayer skin name
+     */
+    @Nullable
+    public String getSkin() {
+        return skin;
+    }
+
+    @Override
+    public boolean isCancelled() {
+        return cancel;
+    }
+
+    @Override
+    public void setCancelled(boolean cancel) {
+        this.cancel = cancel;
+    }
+
+    @Override
+    @NotNull
+    public HandlerList getHandlers() {
+        return handlers;
+    }
+
+    @NotNull
+    public static HandlerList getHandlerList() {
+        return handlers;
+    }
+}
diff --git a/src/main/java/dev/horizonmc/horizon/entity/event/bot/BotEvent.java b/src/main/java/dev/horizonmc/horizon/entity/event/bot/BotEvent.java
new file mode 100644
index 0000000000000000000000000000000000000000..6a5684b6f557c4fff639fc5819d95d93a7a86c97
--- /dev/null
+++ b/src/main/java/dev/horizonmc/horizon/entity/event/bot/BotEvent.java
@@ -0,0 +1,31 @@
+package dev.horizonmc.horizon.entity.event.bot;
+
+import dev.horizonmc.horizon.entity.Bot;
+import org.bukkit.event.Event;
+import org.jetbrains.annotations.NotNull;
+
+/**
+ * Represents a fakeplayer related event
+ */
+public abstract class BotEvent extends Event {
+    protected Bot bot;
+
+    public BotEvent(@NotNull final Bot who) {
+        bot = who;
+    }
+
+    public BotEvent(@NotNull final Bot who, boolean async) { // Paper - public
+        super(async);
+        bot = who;
+    }
+
+    /**
+     * Returns the fakeplayer involved in this event
+     *
+     * @return Fakeplayer who is involved in this event
+     */
+    @NotNull
+    public final Bot getBot() {
+        return bot;
+    }
+}
diff --git a/src/main/java/dev/horizonmc/horizon/entity/event/bot/BotInventoryOpenEvent.java b/src/main/java/dev/horizonmc/horizon/entity/event/bot/BotInventoryOpenEvent.java
new file mode 100644
index 0000000000000000000000000000000000000000..b16f2f7cc5a90c89639eb79bfa94f4446adc616a
--- /dev/null
+++ b/src/main/java/dev/horizonmc/horizon/entity/event/bot/BotInventoryOpenEvent.java
@@ -0,0 +1,46 @@
+package dev.horizonmc.horizon.entity.event.bot;
+
+import dev.horizonmc.horizon.entity.Bot;
+import org.bukkit.entity.Player;
+import org.bukkit.event.Cancellable;
+import org.bukkit.event.HandlerList;
+import org.jetbrains.annotations.NotNull;
+import org.jetbrains.annotations.Nullable;
+
+public class BotInventoryOpenEvent extends BotEvent implements Cancellable {
+    private static final HandlerList handlers = new HandlerList();
+
+    private final Player player;
+    private boolean cancel = false;
+
+    public BotInventoryOpenEvent(@NotNull Bot who, @Nullable Player player) {
+        super(who);
+        this.player = player;
+    }
+
+    @Override
+    public boolean isCancelled() {
+        return cancel;
+    }
+
+    @Override
+    public void setCancelled(boolean cancel) {
+        this.cancel = cancel;
+    }
+
+    @Nullable
+    public Player getOpenPlayer() {
+        return player;
+    }
+
+
+    @Override
+    public @NotNull HandlerList getHandlers() {
+        return handlers;
+    }
+
+    @NotNull
+    public static HandlerList getHandlerList() {
+        return handlers;
+    }
+}
diff --git a/src/main/java/dev/horizonmc/horizon/entity/event/bot/BotJoinEvent.java b/src/main/java/dev/horizonmc/horizon/entity/event/bot/BotJoinEvent.java
new file mode 100644
index 0000000000000000000000000000000000000000..bf526ec96af499b228cec67b037c53ea5f2b3341
--- /dev/null
+++ b/src/main/java/dev/horizonmc/horizon/entity/event/bot/BotJoinEvent.java
@@ -0,0 +1,27 @@
+package dev.horizonmc.horizon.entity.event.bot;
+
+import dev.horizonmc.horizon.entity.Bot;
+import org.bukkit.event.HandlerList;
+import org.jetbrains.annotations.NotNull;
+
+/**
+ * Called when a fakeplayer joins a server
+ */
+public class BotJoinEvent extends BotEvent {
+    private static final HandlerList handlers = new HandlerList();
+
+    public BotJoinEvent(@NotNull Bot who) {
+        super(who);
+    }
+
+    @Override
+    @NotNull
+    public HandlerList getHandlers() {
+        return handlers;
+    }
+
+    @NotNull
+    public static HandlerList getHandlerList() {
+        return handlers;
+    }
+}
diff --git a/src/main/java/org/bukkit/Bukkit.java b/src/main/java/org/bukkit/Bukkit.java
index 8db90b576540dd14769a3c020d8e49f680ff6a97..1cd95d5b7e51fa58f3f40956559ffa37ebebb5ad 100644
--- a/src/main/java/org/bukkit/Bukkit.java
+++ b/src/main/java/org/bukkit/Bukkit.java
@@ -14,6 +14,8 @@ import java.util.Set;
 import java.util.UUID;
 import java.util.function.Consumer;
 import java.util.logging.Logger;
+
+import dev.horizonmc.horizon.entity.BotManager;
 import org.bukkit.Warning.WarningState;
 import org.bukkit.advancement.Advancement;
 import org.bukkit.block.data.BlockData;
@@ -2892,6 +2894,18 @@ public final class Bukkit {
     }
     // Paper end - Folia region threading API
 
+    // Horizon start - Bot API
+
+    /**
+     * Returns a bot manager.
+     *
+     * @return Bot Manager
+     */
+    public static @NotNull BotManager getBotManager() {
+        return server.getBotManager();
+    }
+    // Horizon end - Bot API
+
     @NotNull
     public static Server.Spigot spigot() {
         return server.spigot();
diff --git a/src/main/java/org/bukkit/Server.java b/src/main/java/org/bukkit/Server.java
index 5db367e12a91e929cdfe0ab38b9f6d1ddfa1fed9..c22f20bcd56ccef58ca4103b923f881cd79cc609 100644
--- a/src/main/java/org/bukkit/Server.java
+++ b/src/main/java/org/bukkit/Server.java
@@ -14,6 +14,8 @@ import java.util.Set;
 import java.util.UUID;
 import java.util.function.Consumer;
 import java.util.logging.Logger;
+
+import dev.horizonmc.horizon.entity.BotManager;
 import org.bukkit.Warning.WarningState;
 import org.bukkit.advancement.Advancement;
 import org.bukkit.block.data.BlockData;
@@ -2538,6 +2540,17 @@ public interface Server extends PluginMessageRecipient, net.kyori.adventure.audi
     boolean isOwnedByCurrentRegion(@NotNull Entity entity);
     // Paper end - Folia region threading API
 
+    // Horizon start - Bot API
+
+    /**
+     * Returns a bot manager.
+     *
+     * @return Bot Manager
+     */
+    @NotNull
+    BotManager getBotManager();
+    // Horizon end - Bot API
+
     // Purpur start
     /**
      * Get the name of this server
